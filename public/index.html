<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <title>ABConvert QA</title>
  <style>
    body { font-family: sans-serif; padding: 2rem; }
    #answer { margin-top: 1rem; white-space: pre-wrap; }
    .feedback-row { display: flex; align-items: center; margin-bottom: .5em; }
    .feedback-row label { width: 120px; }
    .rating { display: flex; }
    .rating button {
      flex: 1;
      margin: 0 2px;
      padding: 4px;
      cursor: pointer;
      border: 1px solid #ccc;
      background: #f9f9f9;
    }
    .rating button.selected {
      background: #0070f3;
      color: #fff;
      border-color: #005bb5;
    }
    #submit-feedback {
      padding: 6px 12px;
      cursor: pointer;
    }
    #feedback-message { margin-top: .5em; }
  </style>
</head>
<body>
  <h1>Ask ABConvert</h1>

  <!-- 1) Question input -->
  <form id="askForm">
    <input
      id="question"
      type="text"
      placeholder="How do I set up a price A/B test?"
      style="width: 80%; padding: .5em;"
    />
    <button type="submit" style="padding: .5em 1em;">Ask</button>
  </form>

  <!-- 2) Where we’ll put the answer -->
  <div id="answer"></div>

  <!-- 3) Feedback section (hidden until after answer) -->
  <div id="feedback" style="display:none; margin-top: 1em;">
    <div class="feedback-row">
      <label for="accuracy-rating">Accuracy:</label>
      <div id="accuracy-rating" class="rating"></div>
    </div>
    <div class="feedback-row">
      <label for="helpfulness-rating">Helpfulness:</label>
      <div id="helpfulness-rating" class="rating"></div>
    </div>
    <button id="submit-feedback">Submit Feedback</button>
    <div id="feedback-message"></div>
  </div>

  <script>
    const API_URL = '/api/ask';
    const form    = document.getElementById('askForm');
    const qEl     = document.getElementById('question');
    const answerEl= document.getElementById('answer');
    const fbEl    = document.getElementById('feedback');
    const accEl   = document.getElementById('accuracy-rating');
    const hlpEl   = document.getElementById('helpfulness-rating');
    const subBtn  = document.getElementById('submit-feedback');
    const msgEl   = document.getElementById('feedback-message');

    // Store ratings
    const ratings = { accuracy: 0, helpfulness: 0 };

    // Render 1–10 buttons for a given container and key
    function renderRating(container, key) {
      container.innerHTML = '';
      for (let i = 1; i <= 10; i++) {
        const btn = document.createElement('button');
        btn.textContent = i;
        btn.addEventListener('click', () => {
          ratings[key] = i;
          // highlight selected
          Array.from(container.children).forEach((b, idx) => {
            b.classList.toggle('selected', idx + 1 === i);
          });
        });
        container.appendChild(btn);
      }
    }

    // Show feedback UI after answer
    function showFeedback() {
      renderRating(accEl, 'accuracy');
      renderRating(hlpEl, 'helpfulness');
      msgEl.textContent = '';
      fbEl.style.display = 'block';
    }

    // Submit feedback handler
    subBtn.addEventListener('click', async () => {
    if (!ratings.accuracy || !ratings.helpfulness) {
      msgEl.style.color = 'red';
      msgEl.textContent = 'Please rate both fields.';
      return;
    }

    const payload = {
      question: qEl.value.trim(),
      accuracy: ratings.accuracy,
      helpfulness: ratings.helpfulness
    };

    const res = await fetch('/api/feedback', {
      method: 'POST',
      headers: { 'Content-Type':'application/json' },
      body: JSON.stringify(payload)
    });

    if (res.ok) {
      msgEl.style.color = 'green';
      msgEl.textContent = 'Thanks for your feedback!';
    } else {
      const err = await res.json();
      msgEl.style.color = 'red';
      msgEl.textContent = `Error: ${err.error}`;
    }
  });

    // Main ask handler
    form.addEventListener('submit', async e => {
      e.preventDefault();
      const question = qEl.value.trim();
      if (!question) return;

      answerEl.textContent = '⏳ Thinking…';
      fbEl.style.display = 'none';

      try {
        const res = await fetch(API_URL, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ question })
        });
        if (!res.ok) {
          const txt = await res.text();
          throw new Error(txt);
        }
        const { answer, error } = await res.json();
        if (error) throw new Error(error);
        answerEl.textContent = answer;
        showFeedback();
      } catch (err) {
        answerEl.textContent = '❌ ' + err.message;
      }
    });
  </script>
</body>
</html>
